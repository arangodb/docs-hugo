{{ $link := .Destination -}}
{{ $url := urls.Parse $link -}}
{{ $path := $url.Path -}}
{{ $currentPage := .Page.RelPermalink -}}
{{ $fragment := "" -}}
{{ with $url.Fragment }}
  {{ $fragment = printf "#%s" . }}
{{ end -}}

{{ $permalink := "" -}}
{{ $class := "" }}
{{ $isRemote := ne $url.Scheme "" -}}

{{ if $isRemote -}}
  {{ $permalink = .Destination -}}
{{ else -}}
  {{ $isOnlyFragment := findRE `(?m)^#` $link }}
  {{ if $isOnlyFragment }}
    {{ $permalink = $fragment }}
  {{ else }}
    {{ $page := .Page.GetPage $path -}}
    {{ with $page -}}
      {{ $permalink = printf "%s%s" $page.RelPermalink $fragment -}}
      {{ $class = "link-internal" }}
    {{ else -}}
      {{ if ne $currentPage "/" -}}
        {{ if site.Params.failOnBrokenLinks -}}
          {{ errorf "<error code=1> Broken link '%v' found in %s </error><br>" $link $currentPage -}}
        {{ else -}}
          {{ warnf "Broken link '%v' found in %s" $link $currentPage -}}
        {{ end -}}
      {{ end -}}
    {{ end -}}
  {{ end }}
{{ end }}

<a  href="{{ $permalink | safeURL }}" {{ with .Title }} title="{{ . }}"{{ end }} {{ if $isRemote }} target="_blank" rel="noopener noreferrer" {{ else }} class="{{ $class }}" {{ end }}>{{ .Text | safeHTML }}</a>
{{- /* whitespace control */ -}}