version: 2.1

orbs:
  hugo: circleci/hugo@0.2

jobs:
  checkout: #Checkout a desired repository
    docker:
      - image: cimg/base:current
    resource_class: small
    environment:
      GIT_SSH_COMMAND: ssh -v
      ARANGODB_MAIN_REPO: https://github.com/arangodb/arangodb
      ARANGODB_OLD_DOCS_REPO: https://github.com/arangodb/docs
      ARANGODB_NEW_DOCS_REPO: https://github.com/arangodb/docs-hugo
    steps:
      - run: mkdir -p workspace
      - run:
          name: Clone arangodb main repo
          command: |
            cd workspace && git clone --depth 1 "$ARANGODB_MAIN_REPO" --branch main
      - run:
          name: Clone arangodb old docs repo
          command: |
            cd workspace && git clone "$ARANGODB_OLD_DOCS_REPO"
      - run:
          name: Clone arangodb new docs repo
          command: |
            cd workspace && git clone "$ARANGODB_NEW_DOCS_REPO"
      - run:
          name: check cloned folders
          command: |
            pwd && ls && cd workspace && ls
      - persist_to_workspace:
          root: .
          paths:
            - workspace
  
  migration: 
    docker:
      - image: cimg/python:3.11.2
    resource_class: small
    steps:
      - attach_workspace:
          at: workspace
      - run:
          name: Download migration dependencies
          command: |
            pip install pyyaml python-frontmatter commonmark
      - run: 
          name: Migrate 3.10
          command: |
            cd workspace/workspace/docs-hugo/migration-tools/ && ./migration.sh migrate /home/circleci/project/workspace/workspace/docs /home/circleci/project/workspace/workspace/docs-hugo /home/circleci/project/workspace/workspace/arangodb 3.10
      - run: 
          name: Migrate 3.11
          command: |
            cd workspace/workspace/docs-hugo/migration-tools/ && ./migration.sh migrate /home/circleci/project/workspace/workspace/docs /home/circleci/project/workspace/workspace/docs-hugo /home/circleci/project/workspace/workspace/arangodb 3.11
      - persist_to_workspace:
          root: .
          paths:
            - workspace


  plain-build: 
    docker:
      - image: cimg/base:current
    resource_class: small
    steps:
      - attach_workspace:
          at: workspace
      - run:
          name: Check folders
          command: |
            pwd && ls && cd workspace && ls
          

  complete-build: #Job to execute examples generation + hugo site build
  ###

workflows:
  test:
    jobs:
      - checkout
      - migration:
          requires:
            - checkout
      - plain-build:
          required:
            - migration