version: 2.1

setup: true

orbs:
  continuation: circleci/continuation@0.4.0

parameters:
  workflow:
    type: enum
    enum: [no-op, plain-build, generate, compile, generate-scheduled, commit-generated, generate-oasisctl, create-docs-images-amd64, create-docs-images-arm64]
    default: no-op
  
  deploy-url:
    type: string
    default: $CIRCLE_BRANCH

  generators:
    type: string
    default: ""

  version:
    type: string
    default: ""

  arangodb-branch:
    type: string
    default: ""

  arangodb-3_10:
    type: string
    default: ""

  arangodb-3_11:
    type: string
    default: ""

  arangodb-3_12:
    type: string
    default: ""

  commit-generated:
    type: boolean
    default: false

  create-pr:
    type: boolean
    default: false

jobs:
  generate-config:
    docker:
      - image: cimg/python:3.11.1
    executor: continuation/default
    steps:
      - run:
          name: Checkout
          command: |
            mkdir .circleci && cd .circleci && curl https://api.github.com/repos/arangodb/docs-hugo/contents/.circleci?ref=$CIRCLE_SHA1 | jq ".[].download_url" | xargs wget

      - run:
          name: Generate config # we don't always need to generate the config. Some workflows are ready to go in the base_config.yml
          command: |
              pip install pyyaml
              mkdir ./.circleci/jobs && cd ./.circleci/jobs &&  curl https://api.github.com/repos/arangodb/docs-hugo/contents/.circleci/jobs?ref=$CIRCLE_SHA1 | jq ".[].download_url" | xargs wget

              python3 .circleci/generate_config.py \
                --workflow << pipeline.parameters.workflow >>
                --deploy-url << pipeline.parameters.deploy-url >>

      - continuation/continue:
          configuration_path: ./.circleci/generated_config.yml # use newly generated config to continue
          parameters: ./.circleci/ci-params.json

workflows:
  setup:
    jobs:
      - generate-config
